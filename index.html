<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Expense Approval PWA</title>
    <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)" />
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />

     No dark-mode flash: set class before first paint 
    <script>
      (function () {
        try {
          var ls = localStorage.getItem("theme");
          var prefersDark =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches;
          var isDark = ls ? ls === "dark" : prefersDark;
          var root = document.documentElement;
          if (isDark) root.classList.add("dark");
          else root.classList.remove("dark");
        } catch (e) {}
      })();
    </script>

     Tailwind CDN (dark via class) 
    <script>
      window.tailwind = {
        config: {
          darkMode: "class",
          theme: {
            extend: {
              colors: {
                brand: "#2563eb",
                surface: {
                  DEFAULT: "#0b1220",
                  100: "#0f172a",
                },
                textmuted: "#94a3b8",
                success: "#16a34a",
                warning: "#f59e0b",
                danger: "#ef4444",
              },
              borderRadius: {
                xl: "0.75rem",
              },
              boxShadow: {
                float: "0 10px 25px rgba(0,0,0,0.2)",
              },
            },
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

     Manifest (inline data URI) 
    <link
      rel="manifest"
      href='data:application/manifest+json,{"name":"Expense Approval PWA","short_name":"Expenses","display":"standalone","start_url":"./index.html","background_color":"#ffffff","theme_color":"#2563eb","icons":[{"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAQAAAD4+GvPAAAAAklEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAAAAAAA4A8bVgAAGxYwYgAAAABJRU5ErkJggg==","sizes":"192x192","type":"image/png"},{"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAQAAAB3o3oXAAAAAklEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAAAAAAA4A8bVgAAGxYwYgAAAABJRU5ErkJggg==","sizes":"512x512","type":"image/png"}]}'
    />

     React / ReactDOM / Router UMD 
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.production.min.js" crossorigin></script>

     Dexie (IndexedDB) 
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>

     Tesseract (OCR) 
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>

     Pull-to-refresh 
    <script src="https://unpkg.com/react-simple-pull-to-refresh@1.3.3/dist/index.umd.js"></script>

     Babel Standalone for TS/JSX 
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* Basic pinch-zoom helpers and modal backdrop blur */
      .no-scroll {
        overflow: hidden;
        touch-action: none;
      }
    </style>

     PWA SW register only on http(s) to still open from file:// 
    <script>
      (function () {
        if ("serviceWorker" in navigator && /^https?:/.test(location.protocol)) {
          const swCode = `
            const CACHE = "expense-pwa-v1";
            const toCache = ["./"];
            self.addEventListener("install", (e) => {
              e.waitUntil(caches.open(CACHE).then(c => c.addAll(toCache)).then(() => self.skipWaiting()));
            });
            self.addEventListener("activate", (e) => { e.waitUntil(self.clients.claim()); });
            self.addEventListener("fetch", (e) => {
              const req = e.request;
              if (req.method !== "GET") return;
              e.respondWith(
                caches.match(req).then(res => res || fetch(req).then(r => {
                  const copy = r.clone();
                  caches.open(CACHE).then(c => c.put(req, copy));
                  return r;
                }).catch(() => caches.match("./")))
              );
            });
          `;
          const blob = new Blob([swCode], { type: "text/javascript" });
          const swURL = URL.createObjectURL(blob);
          navigator.serviceWorker.register(swURL).catch(() => {});
        }
      })();
    </script>
  </head>
  <body class="bg-white text-gray-900 dark:bg-surface dark:text-gray-100 antialiased">
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
      const {
        useState,
        useEffect,
        useMemo,
        useCallback,
        useRef,
        createContext,
        useContext,
      } = React;
      const {
        HashRouter,
        Routes,
        Route,
        Navigate,
        useNavigate,
        Link,
        useLocation,
      } = ReactRouterDOM;

      // Types
      type Role = "employee" | "manager" | "admin";
      type ExpenseStatus = "draft" | "submitted" | "approved" | "rejected";
      type Expense = {
        id: string;
        employeeEmail: string;
        title: string;
        amount: number;
        category: string;
        date: string; // ISO
        status: ExpenseStatus;
        managerNote?: string;
        receiptDataUrl?: string; // base64 url
      };
      type User = {
        email: string;
        role: Role;
        name: string;
      };

      // Dexie setup
      class ExpenseDB extends Dexie {
        expenses: Dexie.Table<Expense, string>;
        users: Dexie.Table<User, string>;
        constructor() {
          super("expenseDB");
          this.version(1).stores({
            expenses: "id, employeeEmail, status, date",
            users: "email, role",
          });
          this.expenses = this.table("expenses");
          this.users = this.table("users");
        }
      }
      const db = new ExpenseDB();

      // Seed initial data if empty
      async function seed() {
        const count = await db.expenses.count();
        if (count === 0) {
          const today = new Date();
          const fmt = (d: Date) => d.toISOString().slice(0, 10);
          const sample: Expense[] = [
            {
              id: crypto.randomUUID(),
              employeeEmail: "alice@acme.com",
              title: "Team Lunch",
              amount: 72.5,
              category: "Meals",
              date: fmt(new Date(today.getTime() - 86400000 * 2)),
              status: "submitted",
            },
            {
              id: crypto.randomUUID(),
              employeeEmail: "bob@acme.com",
              title: "Taxi to client",
              amount: 35.9,
              category: "Travel",
              date: fmt(new Date(today.getTime() - 86400000 * 1)),
              status: "approved",
            },
            {
              id: crypto.randomUUID(),
              employeeEmail: "alice@acme.com",
              title: "Office Supplies",
              amount: 18.2,
              category: "Supplies",
              date: fmt(today),
              status: "draft",
            },
          ];
          await db.expenses.bulkAdd(sample);
          await db.users.bulkAdd([
            { email: "alice@acme.com", role: "employee", name: "Alice" },
            { email: "bob@acme.com", role: "manager", name: "Bob" },
            { email: "admin@acme.com", role: "admin", name: "Admin" },
          ]);
        }
      }
      seed();

      // Theme helpers
      function setTheme(t: "light" | "dark") {
        localStorage.setItem("theme", t);
        const root = document.documentElement;
        if (t === "dark") root.classList.add("dark");
        else root.classList.remove("dark");
      }
      function getTheme(): "light" | "dark" {
        const s = localStorage.getItem("theme");
        if (s === "dark" || s === "light") return s;
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      }

      // Auth Context
      type AuthState = {
        user: User | null;
        jwt: string | null;
      };
      type AuthCtx = AuthState & {
        signIn: (email: string, role: Role, name?: string) => Promise<void>;
        signOut: () => void;
      };
      const AuthContext = createContext<AuthCtx | null>(null);
      function useAuth() {
        const ctx = useContext(AuthContext);
        if (!ctx) throw new Error("AuthContext missing");
        return ctx;
      }
      function AuthProvider({ children }: { children: React.ReactNode }) {
        const [user, setUser] = useState<User | null>(null);
        const [jwt, setJwt] = useState<string | null>(null);
        const navigate = useNavigate();

        useEffect(() => {
          const stored = localStorage.getItem("jwt");
          const userJson = localStorage.getItem("user");
          if (stored && userJson) {
            setJwt(stored);
            setUser(JSON.parse(userJson));
          }
        }, []);

        const signIn = useCallback(async (email: string, role: Role, name?: string) => {
          // naive offline "auth"
          const u = await db.users.get(email);
          const userData: User =
            u || { email, role, name: name || email.split("@")[0] };
          if (!u) await db.users.add(userData);
          const token = btoa(`${email}|${role}|${Date.now()}`);
          localStorage.setItem("jwt", token);
          localStorage.setItem("user", JSON.stringify(userData));
          setJwt(token);
          setUser(userData);
          navigate("/app/" + role, { replace: true });
        }, [navigate]);

        const signOut = useCallback(() => {
          localStorage.removeItem("jwt");
          localStorage.removeItem("user");
          setJwt(null);
          setUser(null);
          navigate("/login", { replace: true });
        }, [navigate]);

        return (
          <AuthContext.Provider value={{ user, jwt, signIn, signOut }}>
            {children}
          </AuthContext.Provider>
        );
      }

      // Inactivity timeout: 15m -> toast, then 30s -> sign out if still inactive
      function useInactivityAutoLogout(onExpire: () => void, onWarn: () => void) {
        const warnTimer = useRef<number | null>(null);
        const logoutTimer = useRef<number | null>(null);

        const clearAll = () => {
          if (warnTimer.current) window.clearTimeout(warnTimer.current);
          if (logoutTimer.current) window.clearTimeout(logoutTimer.current);
          warnTimer.current = null;
          logoutTimer.current = null;
        };

        const reset = useCallback(() => {
          clearAll();
          warnTimer.current = window.setTimeout(() => {
            onWarn();
            logoutTimer.current = window.setTimeout(() => {
              onExpire();
            }, 30_000);
          }, 15 * 60_000);
        }, [onWarn, onExpire]);

        useEffect(() => {
          const handler = () => reset();
          const events = ["mousemove", "keydown", "touchstart", "scroll", "click"];
          events.forEach((e) => window.addEventListener(e, handler, { passive: true }));
          reset();
          return () => {
            events.forEach((e) => window.removeEventListener(e, handler as any));
            clearAll();
          };
        }, [reset]);
      }

      // Toast system
      type ToastItem = { id: string; title: string; body?: string; tone?: "info" | "warning" | "success" | "danger" };
      const ToastContext = createContext<{
        push: (t: Omit<ToastItem, "id">) => void;
        remove: (id: string) => void;
      } | null>(null);
      function useToast() {
        const ctx = useContext(ToastContext);
        if (!ctx) throw new Error("ToastContext missing");
        return ctx;
      }
      function ToastProvider({ children }: { children: React.ReactNode }) {
        const [items, setItems] = useState<ToastItem[]>([]);
        const remove = (id: string) =>
          setItems((p) => p.filter((i) => i.id !== id));
        const push = (t: Omit<ToastItem, "id">) => {
          const id = crypto.randomUUID();
          setItems((p) => [...p, { ...t, id }]);
          // Auto-remove non-warning toasts
          if (t.tone !== "warning") {
            setTimeout(() => remove(id), 3500);
          }
        };
        return (
          <ToastContext.Provider value={{ push, remove }}>
            {children}
            <div className="fixed z-50 top-3 right-3 space-y-3">
              {items.map((it) => (
                <div
                  key={it.id}
                  className={
                    "rounded-xl shadow-float px-4 py-3 backdrop-blur bg-white/90 dark:bg-surface/80 border " +
                    (it.tone === "warning"
                      ? "border-yellow-300"
                      : it.tone === "danger"
                      ? "border-red-300"
                      : it.tone === "success"
                      ? "border-green-300"
                      : "border-gray-200 dark:border-gray-700")
                  }
                >
                  <div className="flex items-center justify-between gap-4">
                    <div>
                      <p className="font-medium">{it.title}</p>
                      {it.body ? (
                        <p className="text-sm text-textmuted">{it.body}</p>
                      ) : null}
                    </div>
                    <button
                      className="text-textmuted hover:text-gray-900 dark:hover:text-white"
                      onClick={() => remove(it.id)}
                      aria-label="Dismiss"
                    >
                      ‚úï
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </ToastContext.Provider>
        );
      }

      // CSV export utility
      function exportCSV(rows: any[], columns: { key: string; header: string }[], filename = "export.csv") {
        const escape = (s: any) => {
          let v = s ?? "";
          if (typeof v === "object") v = JSON.stringify(v);
          v = String(v);
          if (/[",\n]/.test(v)) return '"' + v.replace(/"/g, '""') + '"';
          return v;
        };
        const header = columns.map((c) => escape(c.header)).join(",");
        const lines = rows.map((r) => columns.map((c) => escape(r[c.key])).join(","));
        const csv = [header, ...lines].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // Pull-to-refresh component from UMD
      const RTPkg = (window as any).ReactSimplePullToRefresh || (window as any).PullToRefresh || (window as any).default;
      const PullToRefresh: React.FC<{ onRefresh: () => Promise<any>; children: React.ReactNode }> = (props) => {
        const Comp = (RTPkg && (RTPkg.default || RTPkg)) || null;
        if (!Comp) return <>{props.children}</>;
        // react-simple-pull-to-refresh expects onRefresh returning a Promise
        // @ts-ignore
        return <Comp onRefresh={props.onRefresh}>{props.children}</Comp>;
      };

      // Pinch-zoom modal
      function usePinchZoom() {
        const containerRef = useRef<HTMLDivElement | null>(null);
        const imgRef = useRef<HTMLImageElement | null>(null);
        const state = useRef({
          scale: 1,
          originX: 0,
          originY: 0,
          lastDist: 0,
          lastX: 0,
          lastY: 0,
          panX: 0,
          panY: 0,
          pointerCount: 0,
        });

        useEffect(() => {
          const container = containerRef.current!;
          const img = imgRef.current!;
          if (!container || !img) return;

          const setTransform = () => {
            const s = state.current;
            img.style.transform = `translate(${s.panX}px, ${s.panY}px) scale(${s.scale})`;
          };

          function getDist(touches: TouchList) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.hypot(dx, dy);
          }
          function onWheel(e: WheelEvent) {
            e.preventDefault();
            const delta = -e.deltaY;
            const s = state.current;
            s.scale *= delta > 0 ? 1.05 : 0.95;
            s.scale = Math.min(6, Math.max(1, s.scale));
            setTransform();
          }
          function onTouchStart(e: TouchEvent) {
            state.current.pointerCount = e.touches.length;
            if (e.touches.length === 2) {
              state.current.lastDist = getDist(e.touches);
            } else if (e.touches.length === 1) {
              state.current.lastX = e.touches[0].clientX;
              state.current.lastY = e.touches[0].clientY;
            }
          }
          function onTouchMove(e: TouchEvent) {
            if (e.touches.length === 2) {
              e.preventDefault();
              const dist = getDist(e.touches);
              const s = state.current;
              const factor = dist / (s.lastDist || dist);
              s.scale *= factor;
              s.scale = Math.min(6, Math.max(1, s.scale));
              s.lastDist = dist;
              setTransform();
            } else if (e.touches.length === 1) {
              const t = e.touches[0];
              const s = state.current;
              s.panX += t.clientX - s.lastX;
              s.panY += t.clientY - s.lastY;
              s.lastX = t.clientX;
              s.lastY = t.clientY;
              setTransform();
            }
          }
          function onTouchEnd() {
            state.current.pointerCount = 0;
          }
          container.addEventListener("wheel", onWheel, { passive: false });
          container.addEventListener("touchstart", onTouchStart, { passive: false });
          container.addEventListener("touchmove", onTouchMove, { passive: false });
          container.addEventListener("touchend", onTouchEnd);
          return () => {
            container.removeEventListener("wheel", onWheel as any);
            container.removeEventListener("touchstart", onTouchStart as any);
            container.removeEventListener("touchmove", onTouchMove as any);
            container.removeEventListener("touchend", onTouchEnd as any);
          };
        }, []);
        return { containerRef, imgRef };
      }

      function ReceiptModal({
        src,
        onClose,
      }: {
        src: string;
        onClose: () => void;
      }) {
        const { containerRef, imgRef } = usePinchZoom();
        useEffect(() => {
          document.body.classList.add("no-scroll");
          return () => document.body.classList.remove("no-scroll");
        }, []);
        return (
          <div
            className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center"
            onClick={onClose}
            role="dialog"
            aria-modal="true"
          >
            <div
              ref={containerRef}
              className="relative max-w-full max-h-full w-full h-full flex items-center justify-center"
              onClick={(e) => e.stopPropagation()}
            >
              <img
                ref={imgRef}
                src={src || "/placeholder.svg"}
                alt="Receipt full preview"
                className="max-w-none select-none"
                style={{ transformOrigin: "center center" }}
                draggable={false}
              />
              <button
                onClick={onClose}
                className="absolute top-4 right-4 bg-white/90 dark:bg-surface/90 border border-gray-200 dark:border-gray-700 rounded-full px-3 py-1 text-sm shadow"
              >
                Close
              </button>
            </div>
          </div>
        );
      }

      // Shared UI
      function ThemeToggle() {
        const [theme, setT] = useState(getTheme());
        return (
          <button
            className="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-surface/60"
            onClick={() => {
              const next = theme === "dark" ? "light" : "dark";
              setT(next);
              setTheme(next);
            }}
            aria-label="Toggle theme"
          >
            <span className="text-sm">{theme === "dark" ? "Dark" : "Light"}</span>
            <span aria-hidden>üåì</span>
          </button>
        );
      }

      function ExportButton({ rows, columns, filename }: { rows: any[]; columns: { key: string; header: string }[]; filename: string }) {
        return (
          <button
            className="p-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-surface/60"
            title="Export CSV"
            aria-label="Export CSV"
            onClick={() => exportCSV(rows, columns, filename)}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" className="fill-current">
              <path d="M5 20h14v-2H5v2zM12 2l4 4h-3v6h-2V6H8l4-4z" />
            </svg>
          </button>
        );
      }

      function TopBar({
        title,
        right,
      }: {
        title: string;
        right?: React.ReactNode;
      }) {
        const { signOut } = useAuth();
        return (
          <header className="sticky top-0 z-40 bg-white/80 dark:bg-surface/70 backdrop-blur border-b border-gray-200 dark:border-gray-800">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
              <h1 className="text-lg md:text-xl font-semibold text-balance">{title}</h1>
              <div className="flex items-center gap-2">
                {right}
                <ThemeToggle />
                <button
                  className="px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-surface/60"
                  onClick={() => signOut()}
                >
                  Sign out
                </button>
              </div>
            </div>
          </header>
        );
      }

      function SidebarNav() {
        const { user } = useAuth();
        const loc = useLocation();
        const link = (to: string, label: string) => (
          <Link
            to={to}
            className={
              "px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-surface/60 " +
              (loc.pathname === to ? "bg-gray-100 dark:bg-surface/60" : "")
            }
          >
            {label}
          </Link>
        );
        return (
          <aside className="hidden md:block w-64 shrink-0 border-r border-gray-200 dark:border-gray-800 p-4 space-y-2">
            <p className="text-sm text-textmuted mb-2">Role: {user?.role}</p>
            {link("/app/employee", "Employee")}
            {link("/app/manager", "Manager")}
            {link("/app/admin", "Admin")}
          </aside>
        );
      }

      function BottomNav() {
        const loc = useLocation();
        const link = (to: string, label: string, icon: string) => {
          const active = loc.pathname === to;
          return (
            <Link
              to={to}
              className={
                "flex-1 flex flex-col items-center justify-center gap-1 py-2 " +
                (active ? "text-brand" : "text-textmuted")
              }
            >
              <span aria-hidden>{icon}</span>
              <span className="text-xs">{label}</span>
            </Link>
          );
        };
        return (
          <nav className="md:hidden fixed left-4 right-4 bottom-4 z-40 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/90 dark:bg-surface/80 shadow-float flex">
            {link("/app/employee", "Employee", "üë§")}
            {link("/app/manager", "Manager", "üóÇÔ∏è")}
            {link("/app/admin", "Admin", "‚öôÔ∏è")}
          </nav>
        );
      }

      // Expense list item with receipt thumbnail
      function ExpenseRow({
        exp,
        onPreview,
        actions,
      }: {
        exp: Expense;
        onPreview?: (src: string) => void;
        actions?: React.ReactNode;
      }) {
        return (
          <div className="grid grid-cols-12 items-center gap-3 p-3 border-b border-gray-100 dark:border-gray-800">
            <div className="col-span-5 md:col-span-4">
              <p className="font-medium">{exp.title}</p>
              <p className="text-sm text-textmuted">{exp.category}</p>
            </div>
            <div className="col-span-3 md:col-span-2">
              <p className="font-medium">${exp.amount.toFixed(2)}</p>
              <p className="text-sm text-textmuted">{exp.date}</p>
            </div>
            <div className="col-span-2 md:col-span-2">
              <span
                className={
                  "px-2 py-1 rounded text-xs border " +
                  (exp.status === "approved"
                    ? "text-success border-green-300"
                    : exp.status === "rejected"
                    ? "text-danger border-red-300"
                    : exp.status === "submitted"
                    ? "text-warning border-yellow-300"
                    : "text-textmuted border-gray-300 dark:border-gray-700")
                }
              >
                {exp.status}
              </span>
            </div>
            <div className="col-span-2 md:col-span-2">
              {exp.receiptDataUrl ? (
                <button
                  className="text-brand underline"
                  onClick={() => onPreview && onPreview(exp.receiptDataUrl!)}
                >
                  Receipt
                </button>
              ) : (
                <span className="text-textmuted text-sm">No receipt</span>
              )}
            </div>
            <div className="col-span-12 md:col-span-2 flex md:justify-end">
              {actions}
            </div>
          </div>
        );
      }

      // Upload + OCR (Tesseract usage retained)
      function ReceiptUploader({
        onSaved,
      }: {
        onSaved: (dataUrl: string, ocrText?: string) => void;
      }) {
        const [busy, setBusy] = useState(false);
        const fileRef = useRef<HTMLInputElement | null>(null);
        const handleFile = async (f: File) => {
          setBusy(true);
          const reader = new FileReader();
          reader.onload = async () => {
            const dataUrl = reader.result as string;
            // optional OCR
            let text: string | undefined;
            try {
              const { data } = await Tesseract.recognize(dataUrl, "eng", {
                logger: () => {},
              });
              text = data.text?.slice(0, 500);
            } catch (e) {
              // ignore OCR failure
            }
            onSaved(dataUrl, text);
            setBusy(false);
          };
          reader.readAsDataURL(f);
        };
        return (
          <div className="flex items-center gap-2">
            <input
              ref={fileRef}
              type="file"
              accept="image/*"
              className="hidden"
              onChange={(e) => {
                const f = e.target.files?.[0];
                if (f) handleFile(f);
              }}
            />
            <button
              className="px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-surface/60"
              onClick={() => fileRef.current?.click()}
              disabled={busy}
            >
              {busy ? "Processing..." : "Upload receipt"}
            </button>
          </div>
        );
      }

      // Employee screen
      function EmployeeScreen() {
        const { user } = useAuth();
        const [rows, setRows] = useState<Expense[]>([]);
        const [show, setShow] = useState<string | null>(null);
        const [filter, setFilter] = useState<ExpenseStatus | "all">("all");

        const load = useCallback(async () => {
          const list = await db.expenses
            .where("employeeEmail")
            .equals(user!.email)
            .reverse()
            .toArray();
          setRows(list);
        }, [user]);

        useEffect(() => {
          load();
        }, [load]);

        const columns = [
          { key: "title", header: "Title" },
          { key: "category", header: "Category" },
          { key: "amount", header: "Amount" },
          { key: "date", header: "Date" },
          { key: "status", header: "Status" },
        ];
        const visible = rows.filter((r) => (filter === "all" ? true : r.status === filter));

        async function addExpense() {
          const e: Expense = {
            id: crypto.randomUUID(),
            employeeEmail: user!.email,
            title: "New Expense",
            amount: 0,
            category: "Misc",
            date: new Date().toISOString().slice(0, 10),
            status: "draft",
          };
          await db.expenses.add(e);
          await load();
        }
        async function submit(id: string) {
          await db.expenses.update(id, { status: "submitted" });
          await load();
        }
        async function saveReceipt(id: string, dataUrl: string, _ocr?: string) {
          await db.expenses.update(id, { receiptDataUrl: dataUrl });
          await load();
        }

        return (
          <div className="flex-1 min-w-0">
            <TopBar
              title="Your Expenses"
              right={
                <div className="flex items-center gap-2">
                  <ExportButton rows={visible} columns={columns} filename="expenses-employee.csv" />
                  <button
                    className="px-3 py-2 rounded-lg bg-brand text-white"
                    onClick={addExpense}
                  >
                    New
                  </button>
                </div>
              }
            />
            <main className="max-w-7xl mx-auto px-4 pt-4 pb-28 md:pb-8">
              <div className="flex items-center gap-2 mb-3">
                <label className="text-sm text-textmuted">Filter</label>
                <select
                  className="px-2 py-1 rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent"
                  value={filter}
                  onChange={(e) => setFilter(e.target.value as any)}
                >
                  <option value="all">All</option>
                  <option value="draft">Draft</option>
                  <option value="submitted">Submitted</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>

              <PullToRefresh onRefresh={async () => load()}>
                <div className="rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                  {visible.map((x) => (
                    <ExpenseRow
                      key={x.id}
                      exp={x}
                      onPreview={(src) => setShow(src)}
                      actions={
                        <div className="flex items-center gap-2">
                          {x.status === "draft" ? (
                            <button
                              className="px-2 py-1 rounded-lg border border-gray-200 dark:border-gray-700"
                              onClick={() => submit(x.id)}
                            >
                              Submit
                            </button>
                          ) : null}
                          <ReceiptUploader onSaved={(d, o) => saveReceipt(x.id, d, o)} />
                        </div>
                      }
                    />
                  ))}
                  {visible.length === 0 ? (
                    <div className="p-8 text-center text-textmuted">No expenses</div>
                  ) : null}
                </div>
              </PullToRefresh>
            </main>
            <BottomNav />
            {show && <ReceiptModal src={show} onClose={() => setShow(null)} />}
          </div>
        );
      }

      // Manager screen
      function ManagerScreen() {
        const [rows, setRows] = useState<Expense[]>([]);
        const [show, setShow] = useState<string | null>(null);
        const [q, setQ] = useState("");

        const load = useCallback(async () => {
          const list = await db.expenses
            .where("status")
            .equals("submitted")
            .reverse()
            .toArray();
          setRows(list);
        }, []);
        useEffect(() => {
          load();
        }, [load]);

        const columns = [
          { key: "title", header: "Title" },
          { key: "category", header: "Category" },
          { key: "amount", header: "Amount" },
          { key: "date", header: "Date" },
          { key: "employeeEmail", header: "Employee" },
          { key: "status", header: "Status" },
        ];
        const visible = rows.filter(
          (r) =>
            r.title.toLowerCase().includes(q.toLowerCase()) ||
            r.employeeEmail.toLowerCase().includes(q.toLowerCase())
        );

        async function act(id: string, status: "approved" | "rejected") {
          await db.expenses.update(id, { status });
          await load();
        }

        return (
          <div className="flex-1 min-w-0">
            <TopBar
              title="Manager Inbox"
              right={
                <div className="flex items-center gap-2">
                  <ExportButton rows={visible} columns={columns} filename="expenses-manager.csv" />
                </div>
              }
            />
            <main className="max-w-7xl mx-auto px-4 pt-4 pb-28 md:pb-8">
              <div className="mb-3">
                <input
                  value={q}
                  onChange={(e) => setQ(e.target.value)}
                  className="w-full md:w-80 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent"
                  placeholder="Search by title or employee..."
                />
              </div>
              <PullToRefresh onRefresh={async () => load()}>
                <div className="rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                  {visible.map((x) => (
                    <ExpenseRow
                      key={x.id}
                      exp={x}
                      onPreview={(src) => setShow(src)}
                      actions={
                        <div className="flex items-center gap-2">
                          <button
                            className="px-2 py-1 rounded-lg border border-green-300 text-success"
                            onClick={() => act(x.id, "approved")}
                          >
                            Approve
                          </button>
                          <button
                            className="px-2 py-1 rounded-lg border border-red-300 text-danger"
                            onClick={() => act(x.id, "rejected")}
                          >
                            Reject
                          </button>
                        </div>
                      }
                    />
                  ))}
                  {visible.length === 0 ? (
                    <div className="p-8 text-center text-textmuted">No pending submissions</div>
                  ) : null}
                </div>
              </PullToRefresh>
            </main>
            <BottomNav />
            {show && <ReceiptModal src={show} onClose={() => setShow(null)} />}
          </div>
        );
      }

      // Admin screen
      function AdminScreen() {
        const [rows, setRows] = useState<Expense[]>([]);
        const [show, setShow] = useState<string | null>(null);
        const [status, setStatus] = useState<"all" | ExpenseStatus>("all");

        const load = useCallback(async () => {
          const list = await db.expenses.orderBy("date").reverse().toArray();
          setRows(list);
        }, []);
        useEffect(() => void load(), [load]);

        const columns = [
          { key: "title", header: "Title" },
          { key: "category", header: "Category" },
          { key: "amount", header: "Amount" },
          { key: "date", header: "Date" },
          { key: "employeeEmail", header: "Employee" },
          { key: "status", header: "Status" },
        ];
        const visible = rows.filter((r) => (status === "all" ? true : r.status === status));

        return (
          <div className="flex-1 min-w-0">
            <TopBar
              title="Admin ‚Äî All Expenses"
              right={<ExportButton rows={visible} columns={columns} filename="expenses-admin.csv" />}
            />
            <main className="max-w-7xl mx-auto px-4 pt-4 pb-28 md:pb-8">
              <div className="flex items-center gap-2 mb-3">
                <label className="text-sm text-textmuted">Status</label>
                <select
                  className="px-2 py-1 rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent"
                  value={status}
                  onChange={(e) => setStatus(e.target.value as any)}
                >
                  <option value="all">All</option>
                  <option value="draft">Draft</option>
                  <option value="submitted">Submitted</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              <PullToRefresh onRefresh={async () => load()}>
                <div className="rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                  {visible.map((x) => (
                    <ExpenseRow
                      key={x.id}
                      exp={x}
                      onPreview={(src) => setShow(src)}
                    />
                  ))}
                  {visible.length === 0 ? (
                    <div className="p-8 text-center text-textmuted">No expenses</div>
                  ) : null}
                </div>
              </PullToRefresh>
            </main>
            <BottomNav />
            {show && <ReceiptModal src={show} onClose={() => setShow(null)} />}
          </div>
        );
      }

      function Shell() {
        const { user, signOut } = useAuth();
        const toast = useToast();
        useInactivityAutoLogout(
          () => {
            toast.push({
              title: "Signed out due to inactivity",
              tone: "info",
            });
            signOut();
          },
          () => {
            toast.push({
              title: "You‚Äôve been inactive",
              body: "Auto sign out in 30 seconds unless you interact",
              tone: "warning",
            });
          }
        );

        return (
          <div className="min-h-dvh flex">
            <SidebarNav />
            <Routes>
              <Route path="/app/employee" element={<EmployeeScreen />} />
              <Route path="/app/manager" element={<ManagerScreen />} />
              <Route path="/app/admin" element={<AdminScreen />} />
              <Route
                path="*"
                element={<Navigate to={"/app/" + (user?.role || "employee")} replace />}
              />
            </Routes>
          </div>
        );
      }

      function Login() {
        const { signIn } = useAuth();
        const [email, setEmail] = useState("");
        const [role, setRole] = useState<Role>("employee");
        const nav = useNavigate();

        useEffect(() => {
          const jwt = localStorage.getItem("jwt");
          const user = localStorage.getItem("user");
          if (jwt && user) {
            const r = JSON.parse(user).role || "employee";
            nav("/app/" + r, { replace: true });
          }
        }, [nav]);

        return (
          <div className="min-h-dvh flex items-center justify-center px-4">
            <div className="w-full max-w-md rounded-2xl border border-gray-200 dark:border-gray-800 p-6 space-y-4 bg-white/80 dark:bg-surface/70 backdrop-blur">
              <h1 className="text-2xl font-semibold">Sign in</h1>
              <div className="space-y-2">
                <label className="block text-sm">Email</label>
                <input
                  className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="you@acme.com"
                />
              </div>
              <div className="space-y-2">
                <label className="block text-sm">Role</label>
                <select
                  className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent"
                  value={role}
                  onChange={(e) => setRole(e.target.value as Role)}
                >
                  <option value="employee">Employee</option>
                  <option value="manager">Manager</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <button
                className="w-full px-4 py-2 rounded-lg bg-brand text-white"
                onClick={() => signIn(email || (role + "@acme.com"), role)}
              >
                Continue
              </button>
              <div className="flex items-center justify-between">
                <ThemeToggle />
                <p className="text-xs text-textmuted">
                  Offline demo ¬∑ Dexie + Tesseract
                </p>
              </div>
            </div>
          </div>
        );
      }

      function App() {
        return (
          <HashRouter>
            <ToastProvider>
              <AuthProvider>
                <Routes>
                  <Route path="/login" element={<Login />} />
                  <Route path="/app/*" element={<Shell />} />
                  <Route path="*" element={<Navigate to="/login" replace />} />
                </Routes>
              </AuthProvider>
            </ToastProvider>
          </HashRouter>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")!).render(<App />);
    </script>
  </body>
</html>
