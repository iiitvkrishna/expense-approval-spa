<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Expense Approval SPA</title>

     Tailwind CDN (dark mode via class strategy) 
    <script>
      // Initialize theme before paint
      (function () {
        const saved = localStorage.getItem("theme");
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const isDark = saved ? saved === "dark" : prefersDark;
        document.documentElement.classList.toggle("dark", isDark);
      })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Tailwind config: keep defaults, use class-based dark
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            borderRadius: { soft: "0.75rem" },
          },
        },
      };
    </script>

     React, ReactDOM, Router (UMD) 
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.production.min.js"></script>

     Dexie (IndexedDB) 
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>

     Tesseract.js 
    <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

     Babel Standalone for inline TypeScript + React 
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-presets="typescript,react">
      // @ts-nocheck
      // React, Router globals
      const { useState, useEffect, useMemo, useRef, createContext, useContext, Fragment } = React;
      const { createRoot } = ReactDOM;
      const {
        HashRouter,
        Routes,
        Route,
        Link,
        Navigate,
        useNavigate,
        useLocation,
      } = ReactRouterDOM;

      // -------------------------------
      // Utils: hashing, currency, format
      // -------------------------------
      const currencyRates = {
        USD: 1,
        EUR: 0.92,
        GBP: 0.79,
        JPY: 149,
      };

      const formatCurrency = (amount, currency) =>
        new Intl.NumberFormat(undefined, { style: "currency", currency }).format(amount);

      const toUSD = (amount, currency) => {
        const rate = currencyRates[currency] || 1;
        // given 1 USD = rate (foreign), so foreign → USD is divide by rate
        return amount / rate;
      };

      async function hashPassword(pw) {
        const enc = new TextEncoder();
        const buf = await crypto.subtle.digest("SHA-256", enc.encode(pw));
        return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, "0")).join("");
      }

      const nowISO = () => new Date().toISOString();

      // -------------------------------
      // Dexie DB
      // -------------------------------
      class AppDB extends Dexie {
        constructor() {
          super("expense-approval-spa");
          this.version(1).stores({
            kv: "key", // key-val store: key, value
            users: "++id,email,role,isActive",
            rules: "++id,name",
            expenses: "++id,ownerId,status,currentStepIndex,date,currency,category",
          });
          this.kv = this.table("kv");
          this.users = this.table("users");
          this.rules = this.table("rules");
          this.expenses = this.table("expenses");
        }
      }
      const db = new AppDB();

      async function seedIfFirstRun() {
        const seeded = await db.kv.get("seeded");
        if (seeded?.value) return;

        await db.kv.put({ key: "companyName", value: "LocalCorp" });

        const adminHash = await hashPassword("admin");
        await db.users.add({
          email: "admin@local.host",
          passwordHash: adminHash,
          role: "admin", // "employee" | "manager" | "admin"
          isActive: true,
          createdAt: nowISO(),
        });

        // Optional sample manager and employee
        const managerHash = await hashPassword("manager");
        await db.users.add({
          email: "manager@local.host",
          passwordHash: managerHash,
          role: "manager",
          isActive: true,
          createdAt: nowISO(),
        });
        const employeeHash = await hashPassword("employee");
        await db.users.add({
          email: "employee@local.host",
          passwordHash: employeeHash,
          role: "employee",
          isActive: true,
          createdAt: nowISO(),
        });

        // Default rule
        // steps: manager then admin; policy: percent 60%
        const defaultRule = {
          steps: [{ role: "manager" }, { role: "admin" }],
          policy: { type: "percent", value: 60 },
        };
        await db.rules.add({
          name: "Default Two-Step",
          ruleJSON: JSON.stringify(defaultRule, null, 2),
        });

        await db.kv.put({ key: "seeded", value: true });
      }

      // -------------------------------
      // Theme (dark-mode) Provider
      // -------------------------------
      const ThemeContext = createContext({ theme: "light", toggle: () => {} });
      function ThemeProvider({ children }) {
        const [theme, setTheme] = useState(() =>
          document.documentElement.classList.contains("dark") ? "dark" : "light"
        );
        useEffect(() => {
          document.documentElement.classList.toggle("dark", theme === "dark");
          localStorage.setItem("theme", theme);
        }, [theme]);
        return (
          <ThemeContext.Provider value={{ theme, toggle: () => setTheme(prev => (prev === "dark" ? "light" : "dark")) }}>
            {children}
          </ThemeContext.Provider>
        );
      }
      const useTheme = () => useContext(ThemeContext);

      // -------------------------------
      // Toasts (lightweight)
      // -------------------------------
      const ToastContext = createContext({ notify: (opts) => {} });
      function ToastProvider({ children }) {
        const [toasts, setToasts] = useState([]);
        const notify = ({ title = "Notice", message = "", type = "info", timeout = 3000 }) => {
          const id = Math.random().toString(36).slice(2);
          setToasts(prev => [...prev, { id, title, message, type }]);
          setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), timeout);
        };
        return (
          <ToastContext.Provider value={{ notify }}>
            {children}
            <div className="fixed bottom-4 right-4 space-y-2 z-50">
              {toasts.map(t => (
                <div
                  key={t.id}
                  className={[
                    "rounded-soft p-3 shadow-lg w-72",
                    "bg-white/90 dark:bg-gray-900/90 backdrop-blur border",
                    t.type === "success" ? "border-green-400" :
                    t.type === "error" ? "border-red-400" :
                    t.type === "warning" ? "border-amber-400" : "border-indigo-400",
                  ].join(" ")}
                >
                  <div className="font-medium">{t.title}</div>
                  {t.message && <div className="text-sm opacity-80">{t.message}</div>}
                </div>
              ))}
            </div>
          </ToastContext.Provider>
        );
      }
      const useToast = () => useContext(ToastContext);

      // -------------------------------
      // Auth (JWT in-memory)
      // -------------------------------
      const AuthContext = createContext({
        user: null,
        token: null,
        signIn: async (email, password) => {},
        signOut: () => {},
      });

      function AuthProvider({ children }) {
        const [user, setUser] = useState(null);
        const [token, setToken] = useState(null);
        const { notify } = useToast();

        const signIn = async (email, password) => {
          const u = await db.users.where("email").equals(email).first();
          if (!u || !u.isActive) {
            notify({ title: "Login failed", message: "User not found or inactive.", type: "error" });
            return false;
          }
          const hash = await hashPassword(password);
          if (hash !== u.passwordHash) {
            notify({ title: "Login failed", message: "Invalid credentials.", type: "error" });
            return false;
          }
          const payload = { sub: u.id, role: u.role, email: u.email, iat: Date.now() };
          const tkn = btoa(JSON.stringify(payload));
          setUser(u);
          setToken(tkn);
          notify({ title: "Welcome", message: `Logged in as ${u.email}`, type: "success" });
          return true;
        };
        const signOut = () => {
          setUser(null);
          setToken(null);
        };

        return (
          <AuthContext.Provider value={{ user, token, signIn, signOut }}>
            {children}
          </AuthContext.Provider>
        );
      }
      const useAuth = () => useContext(AuthContext);

      // -------------------------------
      // UI Elements
      // -------------------------------
      const Card = ({ title, children, actions }) => (
        <div className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-soft p-4 shadow-sm">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-semibold text-balance">{title}</h2>
            {actions}
          </div>
          <div>{children}</div>
        </div>
      );

      const Badge = ({ status }) => {
        const map = {
          pending: "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-200 border border-amber-200/60 dark:border-amber-700/50",
          approved: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-200 border border-green-200/60 dark:border-green-700/50",
          rejected: "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200 border border-red-200/60 dark:border-red-700/50",
        };
        return <span className={`px-2 py-1 rounded-full text-xs font-medium ${map[status] || "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200"}`}>{status}</span>;
      };

      const Button = ({ children, className = "", ...props }) => (
        <button
          className={[
            "inline-flex items-center justify-center gap-2 px-3 py-2 rounded-md text-sm font-medium",
            "bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed",
            className,
          ].join(" ")}
          {...props}
        >
          {children}
        </button>
      );

      const OutlineButton = ({ children, className = "", ...props }) => (
        <button
          className={[
            "inline-flex items-center justify-center gap-2 px-3 py-2 rounded-md text-sm font-medium",
            "border border-indigo-300 dark:border-indigo-700 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20",
            className,
          ].join(" ")}
          {...props}
        >
          {children}
        </button>
      );

      const TextInput = (props) => (
        <input
          {...props}
          className={[
            "w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950",
            "px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500",
            props.className || "",
          ].join(" ")}
        />
      );

      const Select = (props) => (
        <select
          {...props}
          className={[
            "w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950",
            "px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500",
            props.className || "",
          ].join(" ")}
        />
      );

      const TextArea = (props) => (
        <textarea
          {...props}
          className={[
            "w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950",
            "px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500",
            props.className || "",
          ].join(" ")}
        />
      );

      function Modal({ open, onClose, title, children }) {
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center">
            <div className="absolute inset-0 bg-black/50" onClick={onClose}></div>
            <div className="relative z-10 w-[92vw] max-w-2xl bg-white dark:bg-gray-900 rounded-soft p-4 border border-gray-200 dark:border-gray-800">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">{title}</h3>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">&times;</button>
              </div>
              {children}
            </div>
          </div>
        );
      }

      function Skeleton({ className = "" }) {
        return <div className={["animate-pulse bg-gray-200 dark:bg-gray-800 rounded", className].join(" ")} />;
      }

      // -------------------------------
      // Approval Engine
      // -------------------------------
      async function getActiveRule() {
        const all = await db.rules.toArray();
        return all[0] || null;
      }

      function parseRuleJSON(rule) {
        try {
          return JSON.parse(rule.ruleJSON);
        } catch {
          return { steps: [], policy: { type: "percent", value: 100 } };
        }
      }

      function evaluateStepSatisfaction(approvals, stepIndex, policy) {
        const stepApprovals = approvals.filter(a => a.stepIndex === stepIndex);
        const approvedCount = stepApprovals.filter(a => a.decision === "approved").length;
        const totalResponses = stepApprovals.length;

        if (policy?.type === "absolute") {
          return approvedCount >= (policy.value || 1);
        }
        // default percent
        if (totalResponses === 0) return false;
        const ratio = (approvedCount / totalResponses) * 100;
        return ratio >= (policy.value || 100);
      }

      async function advanceIfSatisfied(expense) {
        const activeRule = await getActiveRule();
        if (!activeRule) return expense;
        const rule = parseRuleJSON(activeRule);

        const stepSatisfied = evaluateStepSatisfaction(expense.approvals || [], expense.currentStepIndex || 0, rule.policy);
        if (!stepSatisfied) return expense;

        const nextIndex = (expense.currentStepIndex || 0) + 1;
        if (nextIndex >= (rule.steps?.length || 0)) {
          // final approval
          expense.status = "approved";
          expense.updatedAt = nowISO();
          await db.expenses.update(expense.id, expense);
          return expense;
        } else {
          // move to next step
          expense.currentStepIndex = nextIndex;
          expense.updatedAt = nowISO();
          await db.expenses.update(expense.id, expense);
          return expense;
        }
      }

      // -------------------------------
      // Header / Nav
      // -------------------------------
      function Header() {
        const { user, signOut } = useAuth();
        const { theme, toggle } = useTheme();
        const [company, setCompany] = useState("LocalCorp");
        useEffect(() => { db.kv.get("companyName").then(v => setCompany(v?.value || "LocalCorp")); }, []);
        return (
          <header className="sticky top-0 z-40 border-b border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/80 backdrop-blur">
            <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="h-8 w-8 rounded-lg bg-indigo-600"></div>
                <div className="font-semibold">{company}</div>
              </div>
              <nav className="flex items-center gap-2">
                <Link className="px-3 py-2 text-sm hover:text-indigo-600" to="/">Home</Link>
                <Link className="px-3 py-2 text-sm hover:text-indigo-600" to="/employee">Employee</Link>
                <Link className="px-3 py-2 text-sm hover:text-indigo-600" to="/manager">Manager</Link>
                <Link className="px-3 py-2 text-sm hover:text-indigo-600" to="/admin">Admin</Link>
              </nav>
              <div className="flex items-center gap-2">
                <OutlineButton onClick={toggle} title="Toggle dark mode">
                  {theme === "dark" ? "Light" : "Dark"}
                </OutlineButton>
                {user ? (
                  <div className="flex items-center gap-2">
                    <span className="text-sm opacity-80 hidden sm:inline">{user.email}</span>
                    <Button onClick={signOut}>Sign out</Button>
                  </div>
                ) : (
                  <Link to="/login"><Button>Sign in</Button></Link>
                )}
              </div>
            </div>
          </header>
        );
      }

      // -------------------------------
      // Auth Guard
      // -------------------------------
      function RequireAuth({ children, roles }) {
        const { user } = useAuth();
        const location = useLocation();
        if (!user) return <Navigate to="/login" state={{ from: location }} replace />;
        if (roles && !roles.includes(user.role)) return <Navigate to="/" replace />;
        return children;
      }

      // -------------------------------
      // Login
      // -------------------------------
      function LoginPage() {
        const nav = useNavigate();
        const { signIn } = useAuth();
        const [email, setEmail] = useState("employee@local.host");
        const [password, setPassword] = useState("employee");

        const onSubmit = async (e) => {
          e.preventDefault();
          const ok = await signIn(email.trim(), password);
          if (ok) nav("/");
        };
        return (
          <main className="max-w-md mx-auto p-4">
            <Card title="Sign in">
              <form onSubmit={onSubmit} className="space-y-3">
                <div>
                  <label className="block text-sm mb-1">Email</label>
                  <TextInput type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                </div>
                <div>
                  <label className="block text-sm mb-1">Password</label>
                  <TextInput type="password" value={password} onChange={e => setPassword(e.target.value)} required />
                </div>
                <Button type="submit" className="w-full">Sign in</Button>
                <div className="text-xs opacity-75">
                  Demo accounts: admin@local.host/admin, manager@local.host/manager, employee@local.host/employee
                </div>
              </form>
            </Card>
          </main>
        );
      }

      // -------------------------------
      // Home
      // -------------------------------
      function HomePage() {
        const { user } = useAuth();
        const [counts, setCounts] = useState({ total: 0, pending: 0, approved: 0, rejected: 0 });
        useEffect(() => {
          db.expenses.toArray().then(arr => {
            setCounts({
              total: arr.length,
              pending: arr.filter(e => e.status === "pending").length,
              approved: arr.filter(e => e.status === "approved").length,
              rejected: arr.filter(e => e.status === "rejected").length,
            });
          });
        }, []);
        return (
          <main className="max-w-6xl mx-auto p-4 space-y-4">
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <div className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-soft p-3">
                <div className="text-xs opacity-70">Total</div>
                <div className="text-2xl font-semibold">{counts.total}</div>
              </div>
              <div className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-soft p-3">
                <div className="text-xs opacity-70">Pending</div>
                <div className="text-2xl font-semibold text-amber-600">{counts.pending}</div>
              </div>
              <div className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-soft p-3">
                <div className="text-xs opacity-70">Approved</div>
                <div className="text-2xl font-semibold text-green-600">{counts.approved}</div>
              </div>
              <div className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-soft p-3">
                <div className="text-xs opacity-70">Rejected</div>
                <div className="text-2xl font-semibold text-red-600">{counts.rejected}</div>
              </div>
            </div>

            <Card title="Welcome" actions={<Link to="/employee"><Button>New Expense</Button></Link>}>
              <p className="text-sm leading-relaxed text-pretty">
                {user ? `Signed in as ${user.email} (${user.role})` : "Please sign in to continue."}
              </p>
              <ul className="mt-3 text-sm list-disc pl-5 space-y-1">
                <li>Dark-mode toggle in header (persists in localStorage).</li>
                <li>Submit expenses with receipt OCR to auto-fill fields.</li>
                <li>Managers/Admins approve per rule policy; status badges indicate state.</li>
                <li>Export all expenses to CSV from Admin.</li>
              </ul>
            </Card>
          </main>
        );
      }

      // -------------------------------
      // Employee: New Expense + My List
      // -------------------------------
      function EmployeePage() {
        const { user } = useAuth();
        const { notify } = useToast();
        const [amount, setAmount] = useState("");
        const [currency, setCurrency] = useState("USD");
        const [category, setCategory] = useState("Meals");
        const [description, setDescription] = useState("");
        const [date, setDate] = useState("");
        const [merchant, setMerchant] = useState("");
        const [receiptDataUrl, setReceiptDataUrl] = useState("");
        const [ocrLoading, setOcrLoading] = useState(false);
        const [ocrProgress, setOcrProgress] = useState(0);
        const [myExpenses, setMyExpenses] = useState([]);
        const [viewImg, setViewImg] = useState("");

        const loadMine = async () => {
          const arr = await db.expenses.where("ownerId").equals(user.id).reverse().sortBy("createdAt");
          setMyExpenses(arr.reverse());
        };
        useEffect(() => { loadMine(); }, []);

        const onFile = (file) => {
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => setReceiptDataUrl(e.target.result);
          reader.readAsDataURL(file);
        };

        const runOCR = async () => {
          if (!receiptDataUrl) return;
          setOcrLoading(true);
          setOcrProgress(0);
          try {
            const { data } = await Tesseract.TesseractWorker
              ? new Tesseract.TesseractWorker().recognize(receiptDataUrl, "eng") // fallback older
              : Tesseract.recognize(receiptDataUrl, "eng", {
                  logger: (m) => {
                    if (m.status === "recognizing text" && m.progress != null) {
                      setOcrProgress(Math.round((m.progress) * 100));
                    }
                  },
                });
            const text = data?.text || "";
            // Heuristics: find amount like 12.34 or 1,234.56
            const amtMatch = text.match(/(\d{1,3}(?:[,\s]\d{3})*(?:\.\d{2})|\d+\.\d{2})/);
            if (amtMatch && !amount) setAmount(amtMatch[0].replace(/[,\s]/g, ""));
            // Date-like patterns yyyy-mm-dd or mm/dd/yyyy
            const dateMatch = text.match(/(\d{4}[-/]\d{2}[-/]\d{2}|\d{1,2}[/.-]\d{1,2}[/.-]\d{2,4})/);
            if (dateMatch && !date) setDate(dateMatch[1].replace(/\./g,"-"));
            // Merchant: first non-empty line
            const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);
            if (lines.length && !merchant) setMerchant(lines[0].slice(0, 64));
            notify({ title: "OCR complete", message: "Fields auto-filled where possible.", type: "success" });
          } catch (e) {
            notify({ title: "OCR failed", message: String(e), type: "error" });
          } finally {
            setOcrLoading(false);
          }
        };

        const submit = async (e) => {
          e.preventDefault();
          if (!amount || !currency || !category || !date) {
            notify({ title: "Missing fields", message: "Please complete required fields.", type: "warning" });
            return;
          }
          const amt = parseFloat(String(amount).replace(",", ""));
          const expense = {
            ownerId: user.id,
            amount: amt,
            currency,
            amountUsd: toUSD(amt, currency),
            category,
            description,
            date,
            merchant,
            receiptDataUrl,
            status: "pending",
            currentStepIndex: 0,
            approvals: [],
            createdAt: nowISO(),
            updatedAt: nowISO(),
          };
          const id = await db.expenses.add(expense);
          notify({ title: "Submitted", message: `Expense #${id} created.`, type: "success" });
          setAmount(""); setDescription(""); setDate(""); setMerchant(""); setReceiptDataUrl("");
          await loadMine();
        };

        return (
          <main className="max-w-6xl mx-auto p-4 space-y-4">
            <Card title="New Expense">
              <form onSubmit={submit} className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm mb-1">Amount</label>
                  <TextInput type="number" step="0.01" value={amount} onChange={e => setAmount(e.target.value)} required />
                </div>
                <div>
                  <label className="block text-sm mb-1">Currency</label>
                  <Select value={currency} onChange={e => setCurrency(e.target.value)}>
                    {Object.keys(currencyRates).map(c => <option key={c} value={c}>{c}</option>)}
                  </Select>
                </div>
                <div>
                  <label className="block text-sm mb-1">Category</label>
                  <Select value={category} onChange={e => setCategory(e.target.value)}>
                    {["Meals", "Travel", "Lodging", "Office", "Other"].map(c => <option key={c} value={c}>{c}</option>)}
                  </Select>
                </div>
                <div>
                  <label className="block text-sm mb-1">Date</label>
                  <TextInput type="date" value={date} onChange={e => setDate(e.target.value)} required />
                </div>
                <div className="sm:col-span-2">
                  <label className="block text-sm mb-1">Description</label>
                  <TextInput value={description} onChange={e => setDescription(e.target.value)} placeholder="e.g. Team lunch with client" />
                </div>
                <div className="sm:col-span-2">
                  <label className="block text-sm mb-1">Merchant</label>
                  <TextInput value={merchant} onChange={e => setMerchant(e.target.value)} placeholder="Optional" />
                </div>

                <div className="sm:col-span-2">
                  <label className="block text-sm mb-1">Receipt image</label>
                  <div className="flex items-center gap-3">
                    <input type="file" accept="image/*" onChange={e => onFile(e.target.files?.[0])} />
                    <OutlineButton type="button" onClick={runOCR} disabled={!receiptDataUrl || ocrLoading}>
                      {ocrLoading ? `OCR ${ocrProgress}%` : "Run OCR"}
                    </OutlineButton>
                  </div>
                  <div className="mt-3">
                    {ocrLoading ? (
                      <div className="grid grid-cols-3 gap-2">
                        <Skeleton className="h-24" />
                        <Skeleton className="h-24" />
                        <Skeleton className="h-24" />
                      </div>
                    ) : receiptDataUrl ? (
                      <img src={receiptDataUrl || "/placeholder.svg"} alt="Receipt preview" className="h-32 rounded-md border border-gray-200 dark:border-gray-800 object-contain" />
                    ) : (
                      <div className="text-sm opacity-70">No image selected.</div>
                    )}
                  </div>
                </div>

                <div className="sm:col-span-2">
                  <Button type="submit">Submit Expense</Button>
                </div>
              </form>
            </Card>

            <Card title="My Expenses">
              {myExpenses.length === 0 ? (
                <div className="text-sm opacity-70">You have no expenses yet.</div>
              ) : (
                <div className="space-y-3">
                  {myExpenses.map(exp => (
                    <div key={exp.id} className="flex items-center justify-between gap-3 p-3 rounded-md border border-gray-200 dark:border-gray-800">
                      <div className="min-w-0">
                        <div className="font-medium text-pretty">
                          {formatCurrency(exp.amount, exp.currency)} • {exp.category}
                        </div>
                        <div className="text-xs opacity-80">
                          {exp.date} • USD eq: {formatCurrency(exp.amountUsd, "USD")} • <Badge status={exp.status} />
                        </div>
                        {exp.description && <div className="text-sm mt-1 opacity-90">{exp.description}</div>}
                        {exp.merchant && <div className="text-xs opacity-70">Merchant: {exp.merchant}</div>}
                      </div>
                      <div className="flex items-center gap-2">
                        {exp.receiptDataUrl && (
                          <button className="text-indigo-600 hover:underline text-sm" onClick={() => setViewImg(exp.receiptDataUrl)}>
                            View receipt
                          </button>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </Card>

            <Modal open={!!viewImg} onClose={() => setViewImg("")} title="Receipt">
              {viewImg ? (
                <img src={viewImg || "/placeholder.svg"} alt="Receipt" className="w-full h-auto rounded-md" />
              ) : null}
            </Modal>
          </main>
        );
      }

      // -------------------------------
      // Manager: Pending approvals
      // -------------------------------
      function ManagerPage() {
        const { user } = useAuth();
        const { notify } = useToast();
        const [items, setItems] = useState([]);
        const [rule, setRule] = useState(null);
        const [viewImg, setViewImg] = useState("");

        const load = async () => {
          const active = await getActiveRule();
          setRule(active ? parseRuleJSON(active) : null);
          const all = await db.expenses.where("status").equals("pending").toArray();
          const pendingForRole = all.filter(e => {
            const stepRole = rule?.steps?.[e.currentStepIndex || 0]?.role;
            return stepRole === "manager";
          });
          setItems(pendingForRole);
        };
        useEffect(() => { load(); }, [user]);

        const act = async (exp, decision) => {
          const comment = decision === "approved" ? "Approved" : prompt("Add a rejection comment:", "") || "Rejected";
          const approval = {
            stepIndex: exp.currentStepIndex || 0,
            userId: user.id,
            decision,
            comment,
            ts: nowISO(),
          };
          const approvals = [...(exp.approvals || []), approval];

          if (decision === "rejected") {
            await db.expenses.update(exp.id, { approvals, status: "rejected", updatedAt: nowISO() });
            notify({ title: "Rejected", message: `Expense #${exp.id} rejected.`, type: "error" });
          } else {
            await db.expenses.update(exp.id, { approvals, updatedAt: nowISO() });
            const updated = await db.expenses.get(exp.id);
            await advanceIfSatisfied(updated);
            notify({ title: "Recorded", message: `Approval recorded for #${exp.id}.`, type: "success" });
          }
          await load();
        };

        return (
          <main className="max-w-6xl mx-auto p-4 space-y-4">
            <Card title="Pending for Manager">
              {items.length === 0 ? (
                <div className="text-sm opacity-70">No pending expenses for Manager step.</div>
              ) : (
                <div className="space-y-3">
                  {items.map(exp => (
                    <div key={exp.id} className="p-3 border border-gray-200 dark:border-gray-800 rounded-md">
                      <div className="flex items-center justify-between">
                        <div className="min-w-0">
                          <div className="font-medium">
                            #{exp.id} • {formatCurrency(exp.amount, exp.currency)} • {exp.category}
                          </div>
                          <div className="text-xs opacity-80">
                            {exp.date} • Owner: {exp.ownerId} • Step {exp.currentStepIndex + 1}/{rule?.steps?.length || 1}
                          </div>
                          {exp.description && <div className="text-sm mt-1">{exp.description}</div>}
                        </div>
                        <div className="flex items-center gap-2">
                          {exp.receiptDataUrl && (
                            <OutlineButton onClick={() => setViewImg(exp.receiptDataUrl)}>View</OutlineButton>
                          )}
                          <Button onClick={() => act(exp, "approved")}>Approve</Button>
                          <OutlineButton onClick={() => act(exp, "rejected")} className="border-red-300 text-red-600 dark:text-red-300 dark:border-red-700">
                            Reject
                          </OutlineButton>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </Card>

            <Modal open={!!viewImg} onClose={() => setViewImg("")} title="Receipt">
              {viewImg ? <img src={viewImg || "/placeholder.svg"} alt="Receipt" className="w-full h-auto rounded-md" /> : null}
            </Modal>
          </main>
        );
      }

      // -------------------------------
      // Admin: Users, Rules, Overrides, Export
      // -------------------------------
      function AdminPage() {
        const { notify } = useToast();
        const [tab, setTab] = useState("users");

        return (
          <main className="max-w-6xl mx-auto p-4 space-y-4">
            <Card
              title="Admin"
              actions={
                <div className="flex items-center gap-2">
                  {["users", "rules", "expenses", "export"].map(t => (
                    <OutlineButton key={t} onClick={() => setTab(t)} className={tab === t ? "bg-indigo-50/50 dark:bg-indigo-900/20" : ""}>
                      {t[0].toUpperCase() + t.slice(1)}
                    </OutlineButton>
                  ))}
                </div>
              }
            >
              {tab === "users" && <AdminUsers />}
              {tab === "rules" && <AdminRules />}
              {tab === "expenses" && <AdminOverrides />}
              {tab === "export" && <AdminExport />}
            </Card>
          </main>
        );
      }

      function AdminUsers() {
        const { notify } = useToast();
        const [users, setUsers] = useState([]);
        const [email, setEmail] = useState("");
        const [role, setRole] = useState("employee");
        const [password, setPassword] = useState("");

        const load = async () => setUsers(await db.users.toArray());
        useEffect(() => { load(); }, []);

        const add = async (e) => {
          e.preventDefault();
          const exists = await db.users.where("email").equals(email.trim()).first();
          if (exists) return notify({ title: "Exists", message: "Email already exists.", type: "warning" });
          const passwordHash = await hashPassword(password);
          await db.users.add({ email: email.trim(), passwordHash, role, isActive: true, createdAt: nowISO() });
          setEmail(""); setPassword("");
          notify({ title: "User created", type: "success" });
          await load();
        };

        const toggleActive = async (u) => {
          await db.users.update(u.id, { isActive: !u.isActive });
          await load();
        };

        return (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h3 className="font-semibold mb-2">Create User</h3>
              <form onSubmit={add} className="space-y-3">
                <div>
                  <label className="block text-sm mb-1">Email</label>
                  <TextInput value={email} onChange={e => setEmail(e.target.value)} required />
                </div>
                <div>
                  <label className="block text-sm mb-1">Password</label>
                  <TextInput type="password" value={password} onChange={e => setPassword(e.target.value)} required />
                </div>
                <div>
                  <label className="block text-sm mb-1">Role</label>
                  <Select value={role} onChange={e => setRole(e.target.value)}>
                    <option value="employee">Employee</option>
                    <option value="manager">Manager</option>
                    <option value="admin">Admin</option>
                  </Select>
                </div>
                <Button type="submit">Create</Button>
              </form>
            </div>
            <div>
              <h3 className="font-semibold mb-2">All Users</h3>
              <div className="space-y-2">
                {users.map(u => (
                  <div key={u.id} className="p-3 border border-gray-200 dark:border-gray-800 rounded-md flex items-center justify-between">
                    <div>
                      <div className="font-medium">{u.email}</div>
                      <div className="text-xs opacity-80">Role: {u.role}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Badge status={u.isActive ? "approved" : "rejected"} />
                      <OutlineButton onClick={() => toggleActive(u)}>{u.isActive ? "Deactivate" : "Activate"}</OutlineButton>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function AdminRules() {
        const { notify } = useToast();
        const [rules, setRules] = useState([]);
        const [name, setName] = useState("");
        const [json, setJson] = useState(`{
  "steps": [{ "role": "manager" }, { "role": "admin" }],
  "policy": { "type": "percent", "value": 60 }
}`);
        const [preview, setPreview] = useState(null);

        const load = async () => {
          const arr = await db.rules.toArray();
          setRules(arr);
          if (arr[0]) setJson(arr[0].ruleJSON);
        };
        useEffect(() => { load(); }, []);

        useEffect(() => {
          try {
            setPreview(JSON.parse(json));
          } catch {
            setPreview(null);
          }
        }, [json]);

        const add = async (e) => {
          e.preventDefault();
          try {
            JSON.parse(json);
          } catch {
            return notify({ title: "Invalid JSON", type: "error" });
          }
          await db.rules.add({ name: name || "Rule", ruleJSON: json });
          setName("");
          notify({ title: "Rule added", type: "success" });
          await load();
        };

        return (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h3 className="font-semibold mb-2">Active Rule (first rule used)</h3>
              <div className="space-y-2">
                {rules.map(r => (
                  <div key={r.id} className="p-3 border border-gray-200 dark:border-gray-800 rounded-md">
                    <div className="font-medium">{r.name}</div>
                    <pre className="mt-2 text-xs overflow-auto max-h-40">{r.ruleJSON}</pre>
                  </div>
                ))}
                {rules.length === 0 && <div className="text-sm opacity-70">No rules yet.</div>}
              </div>
            </div>
            <div>
              <h3 className="font-semibold mb-2">Create / Edit Rule</h3>
              <form onSubmit={add} className="space-y-3">
                <div>
                  <label className="block text-sm mb-1">Name</label>
                  <TextInput value={name} onChange={e => setName(e.target.value)} placeholder="Name (optional)" />
                </div>
                <div>
                  <label className="block text-sm mb-1">Rule JSON</label>
                  <TextArea rows={10} value={json} onChange={e => setJson(e.target.value)} />
                </div>
                <Button type="submit">Save Rule</Button>
              </form>
              <div className="mt-4">
                <h4 className="font-semibold">Live Preview</h4>
                {preview ? (
                  <div className="text-sm mt-2 space-y-1">
                    <div>Steps: {preview.steps?.map((s, i) => s.role || `step ${i+1}`).join(" → ")}</div>
                    <div>Policy: {preview.policy?.type} {preview.policy?.value}</div>
                  </div>
                ) : (
                  <div className="text-sm opacity-70">Invalid JSON</div>
                )}
              </div>
            </div>
          </div>
        );
      }

      function AdminOverrides() {
        const { notify } = useToast();
        const [items, setItems] = useState([]);
        const [viewImg, setViewImg] = useState("");
        const load = async () => setItems(await db.expenses.reverse().sortBy("createdAt"));
        useEffect(() => { load(); }, []);

        const override = async (exp, status) => {
          if (status === "reset") {
            await db.expenses.update(exp.id, { status: "pending", currentStepIndex: 0, updatedAt: nowISO() });
            notify({ title: "Reset", message: `Expense #${exp.id} reset to pending.`, type: "warning" });
          } else {
            await db.expenses.update(exp.id, { status, updatedAt: nowISO() });
            notify({ title: "Overridden", message: `Expense #${exp.id} set to ${status}.`, type: "success" });
          }
          await load();
        };

        return (
          <div className="space-y-3">
            {items.length === 0 ? (
              <div className="text-sm opacity-70">No expenses found.</div>
            ) : items.map(exp => (
              <div key={exp.id} className="p-3 border border-gray-200 dark:border-gray-800 rounded-md">
                <div className="flex items-center justify-between gap-3">
                  <div className="min-w-0">
                    <div className="font-medium">
                      #{exp.id} • {formatCurrency(exp.amount, exp.currency)} • {exp.category} • <Badge status={exp.status} />
                    </div>
                    <div className="text-xs opacity-80">
                      {exp.date} • Owner: {exp.ownerId} • USD eq: {formatCurrency(exp.amountUsd, "USD")}
                    </div>
                    {exp.description && <div className="text-sm mt-1">{exp.description}</div>}
                  </div>
                  <div className="flex items-center gap-2">
                    {exp.receiptDataUrl && <OutlineButton onClick={() => setViewImg(exp.receiptDataUrl)}>View</OutlineButton>}
                    <Button onClick={() => override(exp, "approved")}>Force Approve</Button>
                    <OutlineButton onClick={() => override(exp, "rejected")} className="border-red-300 text-red-600 dark:text-red-300 dark:border-red-700">Force Reject</OutlineButton>
                    <OutlineButton onClick={() => override(exp, "reset")}>Reset</OutlineButton>
                  </div>
                </div>
              </div>
            ))}
            <Modal open={!!viewImg} onClose={() => setViewImg("")} title="Receipt">
              {viewImg ? <img src={viewImg || "/placeholder.svg"} alt="Receipt" className="w-full h-auto rounded-md" /> : null}
            </Modal>
          </div>
        );
      }

      function AdminExport() {
        const { notify } = useToast();
        const exportCSV = async () => {
          const exps = await db.expenses.toArray();
          const headers = [
            "id","ownerId","amount","currency","amountUsd","category","description","date","merchant","status","currentStepIndex","createdAt","updatedAt"
          ];
          const safe = (v) => {
            if (v == null) return "";
            const s = String(v).replace(/"/g, '""');
            return `"${s}"`;
          };
          const rows = [headers.join(",")].concat(
            exps.map(e => headers.map(h => safe(e[h])).join(","))
          );
          const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "expenses.csv";
          a.click();
          URL.revokeObjectURL(url);
          notify({ title: "Exported", message: `Exported ${exps.length} expenses.`, type: "success" });
        };

        return (
          <div className="space-y-2">
            <div className="text-sm opacity-80">Export all expenses as CSV. Fields include USD equivalent for totals.</div>
            <Button onClick={exportCSV}>Export expenses.csv</Button>
          </div>
        );
      }

      // -------------------------------
      // App Shell
      // -------------------------------
      function App() {
        const [ready, setReady] = useState(false);
        useEffect(() => {
          (async () => {
            await seedIfFirstRun();
            setReady(true);
          })();
        }, []);
        if (!ready) {
          return (
            <div className="p-6 max-w-3xl mx-auto">
              <div className="space-y-2">
                <Skeleton className="h-6 w-40" />
                <Skeleton className="h-24 w-full" />
                <Skeleton className="h-24 w-full" />
              </div>
            </div>
          );
        }
        return (
          <HashRouter>
            <Header />
            <Routes>
              <Route path="/login" element={<LoginPage />} />
              <Route path="/" element={<HomePage />} />
              <Route path="/employee" element={
                <RequireAuth roles={["employee","manager","admin"]}>
                  <EmployeePage />
                </RequireAuth>
              } />
              <Route path="/manager" element={
                <RequireAuth roles={["manager","admin"]}>
                  <ManagerPage />
                </RequireAuth>
              } />
              <Route path="/admin" element={
                <RequireAuth roles={["admin"]}>
                  <AdminPage />
                </RequireAuth>
              } />
              <Route path="*" element={<Navigate to="/" replace />} />
            </Routes>
          </HashRouter>
        );
      }

      // -------------------------------
      // Mount app
      // -------------------------------
      const Root = () => (
        <ThemeProvider>
          <ToastProvider>
            <AuthProvider>
              <App />
            </AuthProvider>
          </ToastProvider>
        </ThemeProvider>
      );

      createRoot(document.getElementById("root")).render(<Root />);
    </script>
    <footer class="text-center text-xs opacity-70 py-6">
      Expense Approval SPA • Clean card UI, indigo accent • Runs fully in-browser
    </footer>
  </body>
</html>
